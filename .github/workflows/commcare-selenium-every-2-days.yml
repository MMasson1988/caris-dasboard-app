name: commcare-selenium-hybrid

on:
  schedule:
    # Deux fois par jour : 5h00 locale (09h00 UTC) et 13h00 locale (18h00 UTC)
    - cron: "0 05 * * *"  # 1h00 America/Port-au-Prince
    - cron: "0 18 * * *"  # 13h00 America/Port-au-Prince
  workflow_dispatch:

concurrency:
  group: commcare-selenium-hybrid
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  download:
    runs-on: ubuntu-latest
    env:
      TZ: America/Port-au-Prince
      COMMCARE_DOWNLOAD_DIR: ${{ github.workspace }}/data
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      COMMCARE_DOMAIN: ${{ secrets.COMMCARE_DOMAIN }}  # ex: caris-test
      HEADLESS: "true"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Setup Google Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Setup Chromedriver
        uses: nanasess/setup-chromedriver@v2

      - name: Debug versions
        run: |
          google-chrome --version || true
          chromedriver --version || true
          python --version
          git --version

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -r requirements_py313.txt

      - name: Prepare download directory
        run: mkdir -p "$COMMCARE_DOWNLOAD_DIR"

      - name: ðŸ—‘ï¸ Supprimer les anciens XLSX du repository distant
        run: |
          echo "ðŸ—‘ï¸ Suppression des anciens fichiers XLSX du repository distant..."
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # S'assurer que le dossier data/ existe
          mkdir -p data
          
          # Lister les fichiers XLSX existants
          echo "ðŸ“‹ Fichiers XLSX actuels dans data/ :"
          find data -type f -name "*.xlsx" -ls || echo "Aucun fichier XLSX trouvÃ©."
          
          # Supprimer tous les fichiers .xlsx du dossier data/
          XLSX_COUNT=$(find data -type f -name "*.xlsx" | wc -l)
          if [ "$XLSX_COUNT" -gt 0 ]; then
            echo "ðŸ—‘ï¸ Suppression de $XLSX_COUNT fichiers XLSX..."
            
            # Supprimer les fichiers et les ajouter spÃ©cifiquement Ã  git
            find data -type f -name "*.xlsx" -exec git rm {} \;
            
            # CrÃ©er un fichier .gitkeep pour prÃ©server le dossier data/
            echo "# Ce fichier prÃ©serve le dossier data/ dans Git" > data/.gitkeep
            git add data/.gitkeep
            
            # VÃ©rifier s'il y a des changements Ã  commiter
            if ! git diff --cached --quiet; then
              echo "ðŸ—‘ï¸ Fichiers XLSX supprimÃ©s, crÃ©ation du commit..."
              git commit -m "cleanup: suppression de $XLSX_COUNT fichiers XLSX avant nouveau tÃ©lÃ©chargement (run ${{ github.run_id }})"
              
              # Synchroniser avec le remote avant de pousser
              echo "ðŸ”„ Synchronisation avec le repository distant..."
              git pull --rebase origin main || {
                echo "âš ï¸ Conflit lors du pull, tentative de push force..."
                git push --force-with-lease origin HEAD:main
              }
              
              # Pousser les changements
              git push origin HEAD:main && echo "âœ… Commit de suppression crÃ©Ã© et poussÃ©." || {
                echo "âŒ Ã‰chec du push, tentative avec force-with-lease..."
                git push --force-with-lease origin HEAD:main
              }
            else
              echo "âš ï¸ Aucun changement dÃ©tectÃ© aprÃ¨s suppression."
            fi
          else
            echo "â„¹ï¸ Aucun fichier XLSX Ã  supprimer du repository."
          fi
          
          echo "âœ… Nettoyage du repository distant terminÃ©."

      - name: ðŸ§¹ Clean previous XLSX before new run
        run: |
          echo "ðŸ§¹ Suppression des anciens fichiers XLSX dans $COMMCARE_DOWNLOAD_DIR"
          find "$COMMCARE_DOWNLOAD_DIR" -type f -name "*.xlsx" -delete || true
          echo "âœ… Nettoyage terminÃ©. Contenu actuel :"
          ls -lh "$COMMCARE_DOWNLOAD_DIR" || true

      - name: ðŸ§¼ Clean old logs & JSON reports (keep 3 latest)
        run: |
          echo "ðŸ§¼ Nettoyage des anciens fichiers .log et .json (sauf 3 plus rÃ©cents)..."
          LOGS_DIR="${{ github.workspace }}"
          # Supprime tous sauf les 3 plus rÃ©cents .log
          ls -1t "$LOGS_DIR"/*.log 2>/dev/null | tail -n +4 | xargs -r rm -f
          # Supprime tous sauf les 3 plus rÃ©cents .json
          ls -1t "$LOGS_DIR"/*.json 2>/dev/null | tail -n +4 | xargs -r rm -f
          echo "âœ… Logs conservÃ©s :"
          ls -lh "$LOGS_DIR"/*.log 2>/dev/null || echo "Aucun log restant."
          echo "âœ… Stats conservÃ©es :"
          ls -lh "$LOGS_DIR"/*.json 2>/dev/null || echo "Aucun JSON restant."

      - name: Run Selenium downloader (headless via xvfb)
        timeout-minutes: 360
        run: |
          sudo apt-get update -y
          sudo apt-get install -y xvfb
          xvfb-run -a python downloader/commcare_downloader.py

      # === Artifacts ===
      - name: Upload XLSX artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: commcare-xlsx-${{ github.run_id }}
          path: |
            data/*.xlsx
          if-no-files-found: warn
          retention-days: 90

      - name: Upload logs & stats
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: commcare-logs-${{ github.run_id }}
          path: |
            downloader/commcare_downloader.log
            stats.json
          if-no-files-found: warn
          retention-days: 90

      - name: Debug fichiers avant commit
        if: always()
        shell: bash
        run: |
          echo "ðŸ“ Contenu de data/ :"
          ls -lh data || true
          echo "ðŸ“„ Logs dans downloader/ :"
          ls -lh downloader/*.log 2>/dev/null || echo "Aucun log dans downloader/."
          echo "ðŸŒ¿ Branche :"
          git branch || true
          git status || true

      - name: Commit & Push XLSX < 100MB
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          echo "ðŸ§® SÃ©lection des fichiers < 100MB Ã  commiterâ€¦"
          mapfile -d '' SMALL_FILES < <(find data -type f -name '*.xlsx' -size -100M -print0)

          if [ ${#SMALL_FILES[@]} -eq 0 ]; then
            echo "â„¹ï¸ Aucun fichier < 100MB Ã  commiter."
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -f "${SMALL_FILES[@]}" || true

          if git diff --cached --quiet; then
            echo "â„¹ï¸ Aucun changement indexÃ© (rien Ã  commiter)."
            exit 0
          fi

          COMMIT_MSG="data: push fichiers <100MB (run ${{ github.run_id }})"
          git commit -m "$COMMIT_MSG" || exit 0

          DEFAULT_BRANCH="main"
          
          # Synchroniser avec le remote avant de pousser
          echo "ðŸ”„ Synchronisation avec le repository distant..."
          git pull --rebase origin "$DEFAULT_BRANCH" || {
            echo "âš ï¸ Conflit lors du pull, rÃ©solution automatique..."
            git status
          }
          
          # Pousser les changements
          git push origin HEAD:"$DEFAULT_BRANCH" && echo "âœ… Fichiers poussÃ©s avec succÃ¨s." || {
            echo "âŒ Ã‰chec du push normal, tentative avec force-with-lease..."
            git push --force-with-lease origin HEAD:"$DEFAULT_BRANCH" || echo "âŒ Push impossible mÃªme avec force-with-lease."
          }

      - name: Debug aprÃ¨s commit/push
        if: always()
        shell: bash
        run: |
          echo "ðŸ“ Contenu de data/ aprÃ¨s commit :"
          ls -lh data || true
          echo "ðŸŒ¿ Ã‰tat Git :"
          git status || true

          