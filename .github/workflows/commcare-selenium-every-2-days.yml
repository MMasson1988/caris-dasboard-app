name: commcare-selenium-hybrid

on:
  schedule:
    # Deux fois par jour : 5h00 locale (09h00 UTC) et 13h00 locale (18h00 UTC)
    - cron: "0 07 * * *"  # 3h00 America/Port-au-Prince
    - cron: "0 20 * * *"  # 15h00 America/Port-au-Prince
  workflow_dispatch:

concurrency:
  group: commcare-selenium-hybrid
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  download:
    runs-on: ubuntu-latest
    env:
      TZ: America/Port-au-Prince
      COMMCARE_DOWNLOAD_DIR: ${{ github.workspace }}/data
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      COMMCARE_DOMAIN: ${{ secrets.COMMCARE_DOMAIN }}  # ex: caris-test
      HEADLESS: "true"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Setup Google Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Setup Chromedriver
        uses: nanasess/setup-chromedriver@v2

      - name: Debug versions
        run: |
          google-chrome --version || true
          chromedriver --version || true
          python --version
          git --version

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -r requirements_py313.txt

      - name: Prepare download directory
        run: mkdir -p "$COMMCARE_DOWNLOAD_DIR"

      - name: üóëÔ∏è Supprimer les anciens XLSX du repository distant
        run: |
          echo "üóëÔ∏è Suppression des anciens fichiers XLSX du repository distant..."
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # S'assurer que le dossier data/ existe
          mkdir -p data
          
          # Lister les fichiers XLSX existants
          echo "üìã Fichiers XLSX actuels dans data/ :"
          find data -type f -name "*.xlsx" -ls || echo "Aucun fichier XLSX trouv√©."
          
          # Supprimer tous les fichiers .xlsx du dossier data/
          XLSX_COUNT=$(find data -type f -name "*.xlsx" | wc -l)
          if [ "$XLSX_COUNT" -gt 0 ]; then
            echo "üóëÔ∏è Suppression de $XLSX_COUNT fichiers XLSX..."
            
            # Supprimer les fichiers et les ajouter sp√©cifiquement √† git
            find data -type f -name "*.xlsx" -exec git rm {} \;
            
            # Cr√©er un fichier .gitkeep pour pr√©server le dossier data/
            echo "# Ce fichier pr√©serve le dossier data/ dans Git" > data/.gitkeep
            git add data/.gitkeep
            
            # V√©rifier s'il y a des changements √† commiter
            if ! git diff --cached --quiet; then
              echo "üóëÔ∏è Fichiers XLSX supprim√©s, cr√©ation du commit..."
              git commit -m "cleanup: suppression de $XLSX_COUNT fichiers XLSX avant nouveau t√©l√©chargement (run ${{ github.run_id }})"
              
              # Synchroniser avec le remote avant de pousser
              echo "üîÑ Synchronisation avec le repository distant..."
              git pull --rebase origin main || {
                echo "‚ö†Ô∏è Conflit lors du pull, tentative de push force..."
                git push --force-with-lease origin HEAD:main
              }
              
              # Pousser les changements
              git push origin HEAD:main && echo "‚úÖ Commit de suppression cr√©√© et pouss√©." || {
                echo "‚ùå √âchec du push, tentative avec force-with-lease..."
                git push --force-with-lease origin HEAD:main
              }
            else
              echo "‚ö†Ô∏è Aucun changement d√©tect√© apr√®s suppression."
            fi
          else
            echo "‚ÑπÔ∏è Aucun fichier XLSX √† supprimer du repository."
          fi
          
          echo "‚úÖ Nettoyage du repository distant termin√©."

      - name: üßπ Clean previous XLSX before new run
        run: |
          echo "üßπ Suppression des anciens fichiers XLSX dans $COMMCARE_DOWNLOAD_DIR"
          find "$COMMCARE_DOWNLOAD_DIR" -type f -name "*.xlsx" -delete || true
          echo "‚úÖ Nettoyage termin√©. Contenu actuel :"
          ls -lh "$COMMCARE_DOWNLOAD_DIR" || true

      - name: üßº Clean old logs & JSON reports (keep 3 latest)
        run: |
          echo "üßº Nettoyage des anciens fichiers .log et .json (sauf 3 plus r√©cents)..."
          LOGS_DIR="${{ github.workspace }}"
          # Supprime tous sauf les 3 plus r√©cents .log
          ls -1t "$LOGS_DIR"/*.log 2>/dev/null | tail -n +4 | xargs -r rm -f
          # Supprime tous sauf les 3 plus r√©cents .json
          ls -1t "$LOGS_DIR"/*.json 2>/dev/null | tail -n +4 | xargs -r rm -f
          echo "‚úÖ Logs conserv√©s :"
          ls -lh "$LOGS_DIR"/*.log 2>/dev/null || echo "Aucun log restant."
          echo "‚úÖ Stats conserv√©es :"
          ls -lh "$LOGS_DIR"/*.json 2>/dev/null || echo "Aucun JSON restant."

      - name: Run Selenium downloader (headless via xvfb)
        timeout-minutes: 360
        run: |
          sudo apt-get update -y
          sudo apt-get install -y xvfb
          xvfb-run -a python commcare_downloader.py

      # === Artifacts ===
      - name: Upload XLSX artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: commcare-xlsx-${{ github.run_id }}
          path: |
            data/*.xlsx
          if-no-files-found: warn
          retention-days: 90

      - name: Upload logs & stats
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: commcare-logs-${{ github.run_id }}
          path: |
            commcare_downloader.log
            stats.json
          if-no-files-found: warn
          retention-days: 90

      - name: Debug fichiers avant commit
        if: always()
        shell: bash
        run: |
          echo "üìÅ Contenu de data/ :"
          ls -lh data || true
          echo "üåø Branche :"
          git branch || true
          git status || true

      - name: Commit & Push XLSX < 100MB
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          echo "üßÆ S√©lection des fichiers < 100MB √† commiter‚Ä¶"
          mapfile -d '' SMALL_FILES < <(find data -type f -name '*.xlsx' -size -100M -print0)

          if [ ${#SMALL_FILES[@]} -eq 0 ]; then
            echo "‚ÑπÔ∏è Aucun fichier < 100MB √† commiter."
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -f "${SMALL_FILES[@]}" || true

          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è Aucun changement index√© (rien √† commiter)."
            exit 0
          fi

          COMMIT_MSG="data: push fichiers <100MB (run ${{ github.run_id }})"
          git commit -m "$COMMIT_MSG" || exit 0

          DEFAULT_BRANCH="main"
          
          # Synchroniser avec le remote avant de pousser
          echo "üîÑ Synchronisation avec le repository distant..."
          git pull --rebase origin "$DEFAULT_BRANCH" || {
            echo "‚ö†Ô∏è Conflit lors du pull, r√©solution automatique..."
            git status
          }
          
          # Pousser les changements
          git push origin HEAD:"$DEFAULT_BRANCH" && echo "‚úÖ Fichiers pouss√©s avec succ√®s." || {
            echo "‚ùå √âchec du push normal, tentative avec force-with-lease..."
            git push --force-with-lease origin HEAD:"$DEFAULT_BRANCH" || echo "‚ùå Push impossible m√™me avec force-with-lease."
          }

      - name: Debug apr√®s commit/push
        if: always()
        shell: bash
        run: |
          echo "üìÅ Contenu de data/ apr√®s commit :"
          ls -lh data || true
          echo "üåø √âtat Git :"
          git status || true

          